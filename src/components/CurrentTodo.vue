<template lang="pug">
  v-container(style='maxWidth: 1000px;' :class='$vuetify.breakpoint.mdAndUp ? "pb-8" : ""')
    v-list
      v-list-item
        v-progress-linear(rounded
        :value='progress'
        height='25'
        :color='$vuetify.theme.dark ? undefined : "blue lighten-3"'
        :loading='todoUpdating')
          template(v-slot='{ value }')
            span.caption {{todosCount - incompleteTodosCount}}/{{todosCount}}
        v-spacer.px-2
        v-btn(text icon :loading='todoUpdating' @click='updateTodo')
          v-icon refresh
      v-list-item
        v-list-item-content(v-if='!!todo')
          v-card.grey(:class="$vuetify.theme.dark ? 'darken-2' : 'lighten-4'")
            v-card-text
              TodoText(:todo='todo')
            v-card-actions
              span.caption.grey--text.pl-2 {{$t('created')}} {{todo.createdAt.substr(0, 10)}}
              span.caption.grey--text.pl-2(v-if='todo.skipped') ({{$t('skipped')}})
              v-spacer
              v-btn(text
              icon
              :loading='loading'
              @click='deleteTodo')
                v-icon delete
              v-btn.ma-0(text
              icon
              @click='skipTodo'
              :loading='loading'
              v-if='incompleteTodosCount > 1 && !todo.frog')
                v-icon arrow_right_alt
              v-tooltip(:max-width='300' bottom).ml-4
                template(v-slot:activator='{ on }')
                  v-btn(text
                  icon
                  @click='addTodo'
                  :loading='loading'
                  v-on='on'
                  v-shortkey.once="{ en: ['b'], ru: ['–∏'] }"
                  @shortkey='addTodo')
                    v-icon list
                span {{$t('breakdownInfo')}}
              v-btn.ma-0(text
              icon
              @click='completeTodo'
              :loading='loading'
              v-shortkey.once="{ en: ['d'], ru: ['–≤']}"
              @shortkey='completeTodo')
                v-icon done
        v-list-item-content(v-if='!todo && !loading && !todoUpdating && todosCount > 0').text-center.mt-4
          span.display-3 üéâ
          span.headline {{$t('clear.congratulations')}}
          span.body-1 {{$t('clear.text')}}
        v-list-item-content(v-if='!todo && !loading && !todoUpdating && todosCount === 0').text-center.mt-4
          span.display-3 üêù
          span.headline {{$t('empty.action')}}
          span.body-1 {{$t('empty.text')}}
    DeleteTodo(:todo='todoDeleted')
</template>

<script lang="ts">
import Vue from "vue";
import Component from "vue-class-component";
import { Todo } from "../models/todo";
import { getTodos, editTodo } from "../utils/api";
import * as store from "../plugins/store";
import TodoText from "./TodoText.vue";
import DeleteTodo from "./DeleteTodo.vue";
import { Watch } from "vue-property-decorator";
import * as api from "../utils/api";
import { serverBus } from "../main";

@Component({
  components: {
    TodoText,
    DeleteTodo
  }
})
export default class CurrentTodo extends Vue {
  showCompleted = false;
  todo: Todo | null = null;
  incompleteTodosCount = 0;
  todosCount = 0;

  loading = false;

  todoDeleted: Todo | null = null;

  get progress() {
    return this.todosCount === 0
      ? 0
      : (
          ((this.todosCount - this.incompleteTodosCount) / this.todosCount) *
          100
        ).toFixed(0);
  }

  mounted() {
    this.updateTodo();
  }

  created() {
    serverBus.$on("refreshRequested", () => {
      this.updateTodo();
    });
  }

  todoUpdating = false;
  async updateTodo() {
    if (this.todoUpdating) {
      return;
    }
    const user = store.user();
    if (!user) {
      return;
    }
    this.todoUpdating = true;
    try {
      const fetched = await api.getCurrentTodo(user);
      this.todo = fetched.todo || null;
      this.incompleteTodosCount = fetched.incompleteTodosCount;
      this.todosCount = fetched.todosCount;
    } catch (err) {
      store.setSnackbarError("errors.loadTodos");
    } finally {
      this.todoUpdating = false;
    }
  }

  async completeTodo() {
    const user = store.user();
    if (!user) {
      return;
    }
    if (!this.todo) {
      return;
    }
    this.loading = true;
    try {
      await api.completeTodo(user, this.todo);
      this.updateTodo();
    } catch (err) {
      store.setSnackbarError(err.response ? err.response.data : err.message);
    } finally {
      this.loading = false;
    }
  }

  async deleteTodo() {
    this.todoDeleted = this.todo ? { ...this.todo } : null;
  }

  addTodo() {
    serverBus.$emit("addTodoRequested", undefined, this.todo);
  }

  async skipTodo() {
    const user = store.user();
    if (!user) {
      return;
    }
    if (!this.todo) {
      return;
    }
    this.loading = true;
    try {
      await api.skipTodo(user, this.todo);
      this.updateTodo();
    } catch (err) {
      store.setSnackbarError(err.response ? err.response.data : err.message);
    } finally {
      this.loading = false;
    }
  }
}
</script>

